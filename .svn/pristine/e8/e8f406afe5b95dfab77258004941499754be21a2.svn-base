<?php

namespace app\controllers;

use Yii;
use yii\web\Controller;
use yii\filters\AccessControl;
use yii\filters\VerbFilter;
use yii\helpers\Json;
use app\common\Common;
use app\models\Dictitem;
use app\models\User;
use yii\data\Pagination;
use app\models\OrderCharge;

class OrderChargeController extends Controller
{
    public $layout = false; //设置使用的布局文件
    public $enableCsrfValidation = false;

    /*
        * @function 权限验证
        * @date 2016-4-17
        */
    public function beforeAction($action)
    {
        if(is_null(yii::$app->session['username']) || yii::$app->session['userType'] != '2')
        {
            $this->redirect(['login/index']);

            return false;
        }else{
            return parent::beforeAction($action); // TODO: Change the autogenerated stub

        }
    }

    public function actionList()
    {
        return $this->render('list');
    }

    /*
	 * 市场部列表页
	 */
    public function actionListall()
    {
        $username = Yii::$app->request->get('username');
        $para = array();
        $para['username'] = $username;
        $whereStr = 'departmentId = "zsyj5706180734b523zsyj32715678"';//查询条件
        if ($username != '') {
            $whereStr = $whereStr . " and username like '%" . $username . "%'";
        }

        $users = User::find()->where($whereStr);
        $pages = new Pagination(['totalCount' => $users->count(), 'pageSize' => Common::PAGESIZE]);//分页
        $models = $users->offset($pages->offset)->limit($pages->limit)->all();
        $dictItem = Dictitem::find()
            ->where(['dictCode' => 'DICT_STATE'])
            ->all();
        $dictItemS = Dictitem::find()
            ->where(['dictCode' => 'DICT_SEX'])
            ->all();
        foreach($models as $key=>$data) {
            foreach ($dictItem as $index => $value) {
                if ($data->userState == $value->dictItemCode) {
                    $models[$key]->userState = $value->dictItemName;
                }
            }
            foreach($dictItemS as $index=>$value){
                if($data->sex == $value->dictItemCode){
                    $models[$key]->sex = $value->dictItemName;
                }
            }
        }
        return $this->render('listall', [
            'users' => $models,
            'pages' => $pages,
            'para' => $para,
        ]);
    }

    /*
     * 显示地区列表页
     */
    public function actionAssign()
    {
        $id = Yii::$app->request->get('id');

        return $this->render('listarea',[
            'userId' => $id
        ]);
    }

    /*
     * 选择或多选地区给用户
     */
    public function actionAddarea()
    {
        $ids = Yii::$app->request->post('ids');
        $userId = Yii::$app->request->post('userId');
        $ids_array = explode('-',$ids);
        foreach($ids_array as $key => $data){
            $ordercharge = new Ordercharge();
            $ordercharge->id = Common::generateID();//默认方法生成ID
            $ordercharge->userId = $userId;
            $ordercharge->areaAddress = $data;
            $ordercharge->save();
        }
        return 'success';
    }
}
